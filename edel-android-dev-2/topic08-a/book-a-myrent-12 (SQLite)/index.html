 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      8-a: SQLite (MyRent)
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="MyRent-12 (SQLite)">
      MyRent-12 (SQLite)
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic07-a/book-a-myrent-10 (Maps - Google)/index.html">
          MyRent-11 (Maps - Google)
        </a>
      
    
      
        <a class="item" href="../../topic07-a/book-b-myrent-10 (Maps - MapBox)/index.html">
          MyRent-11a (Maps - MapBox)
        </a>
      
    
      
        <a class="item" href="../../topic07-b/book-a-myrent-sqlite (SQLite)/index.html">
          MyRentSQLite (SQLite)
        </a>
      
    
      
        <a class="active item" href="../../topic08-a/book-a-myrent-12 (SQLite)/index.html">
          MyRent-12 (SQLite)
        </a>
      
    
      
        <a class="item" href="../../topic08-b/book-b-myrent-sqlite (ContentProvider)/index.html">
          MyRentSQLite (ContentProvider)
        </a>
      
    
      
        <a class="item" href="../../topic09-a/book-a-myrent-service/index.html">
          MyRent (Play Service)
        </a>
      
    
      
        <a class="item" href="../../topic09-a/book-a-myrent-service-test/index.html">
          MyRent (JUnit Test)
        </a>
      
    
      
        <a class="item" href="../../topic09-a/book-b-myrent-14 (Retrofit Client)/index.html">
          MyRent-13 (Client)
        </a>
      
    
      
        <a class="item" href="../../topic10-a/book-b-services/index.html">
          MyRent-14 (Services)
        </a>
      
    
      
        <a class="item" href="../../topic11-a/book-a-myrent-11 (Camera)/index.html">
          MyRent-15 (Camera)
        </a>
      
    
      
        <a class="item" href="../../topic11-b/book-a-crypto/index.html">
          App Signing & Crypto
        </a>
      
    
      
        <a class="item" href="../../topic11-c/book-a-myrent-16(Mongo)/index.html">
          MyRent-16 (Mongo)
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="MyRent-12 (SQLite)">
        <h1>SQLite</h1>
<p>In the MyRent series of labs we have used file storage as a means of data persistence. In an earlier lab we introduced an SQLite database to an app based on a subset of MyRent.Here we replace the file system in MyRent with an SQLite database. Later we shall open up this database to other applications using Android&#39;s ContentProvider.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Introduction</h1>
<p>In the previous SQLite lab we worked with a subset of MyRent. Here we integrate an SQLite database into the full MyRent app, replacing the existing file storage system. Resume development from the end of the cameral module.</p>
<p>We shall remove all references to the PortfolioSerializer, replacing it with appropriate SQLite related code. The Portfolio class will still be retained and the local in-memory storage of residence objects preserved also.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>App</h1>
<p>The project structure, showing the packages you should create, is shown here in Figure 1.</p>
<p><img src="img/01.png" alt="Figure 1: Project structure"></p>
<p>In MyRentApp delete the PortfolioSerializer field and associated code. Also, delete the PortfolioSerializer file.</p>
<p>Observe that we have changed the signature of the Portfolio constructor, removing the serializer object and replacing it with the application context. This generates an error that will be resolved when we later refactor Portfolio.</p>
<p>Here is the refactored class. </p>
<pre><code>
package org.wit.myrent.app;

import android.app.Application;
import android.util.Log;
import org.wit.myrent.models.Portfolio;


public class MyRentApp extends Application
{
  static final String TAG = &quot;MyRentApp&quot;;
  public Portfolio portfolio;

  protected static MyRentApp app;
  @Override
  public void onCreate()
  {
    super.onCreate();
    portfolio = new Portfolio(getApplicationContext());
    Log.d(TAG, &quot;MyRent app launched&quot;);
    app = this;
  }

  public static MyRentApp getApp(){
    return app;
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Portfolio</h1>
<p>Here we summarise the changes and follow with the refactored class:</p>
<ul>
<li>We replace the PortfolioSerializer field with a DbHelper.</li>
<li>In the addResidence method we save to both the local list of residences and to the database.</li>
<li>In the deleteResidence method we delete from both the local and the database storage.</li>
<li>We add a new method, <code>updateResidence</code> updates an existing element in the local list and the matching record in the database (it&#39;s id remains unchanged).</li>
<li>Also added is a method <code>refreshResidences</code> that clears the content from the local list of residences and replaces it with the content of the incoming parameter list.</li>
</ul>
<p>Before proceeding, replace ResidenceFragment.onPause with the following (portfolio now invokes the newly introduced method <code>updateResidence</code>):</p>
<pre><code>  @Override
  public void onPause() {
    super.onPause();
    portfolio.updateResidence(residence);
  }</code></pre>
<p>Here is the refactored Portfolio class:</p>
<pre><code>package org.wit.myrent.models;

import static org.wit.android.helpers.LogHelpers.info;

import java.util.ArrayList;
import java.util.List;

import android.content.Context;
import android.util.Log;

import org.wit.myrent.sqlite.DbHelper;

public class Portfolio
{
  public ArrayList&lt;Residence&gt; residences;
  public DbHelper dbHelper;

  public Portfolio(Context context) {
    try {
      dbHelper = new DbHelper(context);
      residences = (ArrayList&lt;Residence&gt;) dbHelper.selectResidences();
    }
    catch (Exception e) {
      info(this, &quot;Error loading residences: &quot; + e.getMessage());
      residences = new ArrayList&lt;Residence&gt;();
    }
  }

  /**
   * Obtain the entire database of residences
   *
   * @return All the residences in the database as an ArrayList
   */
  public ArrayList&lt;Residence&gt; selectResidences() {
    return (ArrayList&lt;Residence&gt;) dbHelper.selectResidences();
  }

  /**
   * Add incoming residence to both local and database storage
   *
   * @param residence The residence object to be added to local and database storage.
   */
  public void addResidence(Residence residence) {
    residences.add(residence);
    dbHelper.addResidence(residence);
  }

  /**
   * Obtain specified residence from local list and return.
   *
   * @param id The Long id identifier of the residence sought.
   * @return The specified residence if it exists.
   */
  public Residence getResidence(Long id) {
    Log.i(this.getClass().getSimpleName(), &quot;Long id id: &quot; + id);

    for (Residence res : residences) {
      if (id.equals(res.id)) {
        return res;
      }
    }
    info(this, &quot;failed to find residence. returning first element array to avoid crash&quot;);
    return null;
  }

  /**
   * Delete Residence object from local and remote storage
   *
   * @param residence Residence object for deletion.
   */
  public void deleteResidence(Residence residence) {
    dbHelper.deleteResidence(residence);
    residences.remove(residence);
  }

  public void updateResidence(Residence residence) {
    dbHelper.updateResidence(residence);
    updateLocalResidences(residence);

  }

  /**
   * Clear local and sqlite residences and refresh with incoming list.
   * @param residences List residence objects
   */
  public void refreshResidences(List&lt;Residence&gt; residences)
  {
    dbHelper.deleteResidences();
    this.residences.clear();

    dbHelper.addResidences(residences);

    for (int i = 0; i &lt; residences.size(); i += 1) {
      this.residences.add(residences.get(i));
    }
  }

  /**
   * Search the list of residences for argument residence
   * If found replace it with argument residence.
   * If not found just add the argument residence.
   *
   * @param residence The Residence object with which the list of Residences to be updated.
   */
  private void updateLocalResidences(Residence residence) {
    for (int i = 0; i &lt; residences.size(); i += 1) {
      Residence r = residences.get(i);
      if (r.id.equals(residence.id)) {
        residences.remove(i);
        residences.add(residence);
        return;
      }
    }
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>DbHelper</h1>
<p>Finally, we introduce a copy of the DbHelper class that we developed in the earlier MyRentSQLite app but modified to reflect different Residence id and date types:</p>
<pre><code>package org.wit.myrent.sqlite;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.DatabaseUtils;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;
import android.util.Log;

import org.wit.myrent.models.Residence;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

public class DbHelper extends SQLiteOpenHelper
{
  static final String TAG = &quot;DbHelper&quot;;
  static final String DATABASE_NAME = &quot;residences.db&quot;;
  static final int DATABASE_VERSION = 1;
  static final String TABLE_RESIDENCES = &quot;tableResidences&quot;;

  static final String PRIMARY_KEY = &quot;id&quot;;
  static final String GEOLOCATION = &quot;geolocation&quot;;
  static final String DATE = &quot;date&quot;;
  static final String RENTED = &quot;rented&quot;;
  static final String TENANT = &quot;tenant&quot;;
  static final String ZOOM = &quot;zoom&quot;;
  static final String PHOTO = &quot;photo&quot;;

  Context context;

  public DbHelper(Context context) {
    super(context, DATABASE_NAME, null, DATABASE_VERSION);
    this.context = context;
  }

  @Override
  public void onCreate(SQLiteDatabase db) {
    String createTable =
        &quot;CREATE TABLE tableResidences &quot; +
            &quot;(id text primary key, &quot; +
            &quot;geolocation text,&quot; +
            &quot;date text,&quot; +
            &quot;rented text,&quot; +
            &quot;tenant text,&quot; +
            &quot;zoom text,&quot; +
            &quot;photo text)&quot;;

    db.execSQL(createTable);
    Log.d(TAG, &quot;DbHelper.onCreated: &quot; + createTable);
  }

  /**
   * @param residence Reference to Residence object to be added to database
   */
  public void addResidence(Residence residence) {
    SQLiteDatabase db = this.getWritableDatabase();
    ContentValues values = new ContentValues();
    values.put(PRIMARY_KEY, residence.id);
    values.put(GEOLOCATION, residence.geolocation);
    values.put(DATE, residence.date);
    values.put(RENTED, residence.rented == true ? &quot;yes&quot; : &quot;no&quot;);
    values.put(TENANT, residence.tenant);
    values.put(ZOOM, Double.toString(residence.zoom));
    values.put(PHOTO, residence.photo);

    // Insert record
    db.insert(TABLE_RESIDENCES, null, values);
    db.close();
  }

  /**
   * Persist a list of residences
   *
   * @param residences The list of Residence object to be saved to database.
   */
  public void addResidences(List&lt;Residence&gt; residences) {
    for (Residence residence : residences) {
      addResidence(residence);
    }
  }

  public Residence selectResidence(UUID resId) {
    Residence residence;
    SQLiteDatabase db = this.getReadableDatabase();
    Cursor cursor = null;

    try {
      residence = new Residence();

      cursor = db.rawQuery(&quot;SELECT * FROM tableResidences WHERE uuid = ?&quot;, new String[]{resId.toString() + &quot;&quot;});

      if (cursor.getCount() &gt; 0) {
        int columnIndex = 0;
        cursor.moveToFirst();
        residence.id = cursor.getLong(columnIndex++);
        residence.geolocation = cursor.getString(columnIndex++);
        residence.date = Long.parseLong(cursor.getString(columnIndex++));
        residence.rented = cursor.getString(columnIndex++).equalsIgnoreCase(&quot;yes&quot;) ? true : false;
        residence.tenant = cursor.getString(columnIndex++);
        residence.zoom = Double.parseDouble(cursor.getString(columnIndex++));
        residence.photo = cursor.getString(columnIndex++);
      }
    }
    finally {
      cursor.close();
    }
    return residence;
  }

  public void deleteResidence(Residence residence) {
    SQLiteDatabase db = this.getWritableDatabase();
    try {
      db.delete(&quot;tableResidences&quot;, &quot;id&quot; + &quot;=?&quot;, new String[]{residence.id + &quot;&quot;});
    }
    catch (Exception e) {
      Log.d(TAG, &quot;delete residence failure: &quot; + e.getMessage());
    }
  }

  /**
   * Query database and select entire tableResidences.
   *
   * @return A list of Residence object records
   */
  public List&lt;Residence&gt; selectResidences() {
    List&lt;Residence&gt; residences = new ArrayList&lt;Residence&gt;();
    String query = &quot;SELECT * FROM &quot; + &quot;tableResidences&quot;;
    SQLiteDatabase db = this.getWritableDatabase();
    Cursor cursor = db.rawQuery(query, null);
    if (cursor.moveToFirst()) {
      int columnIndex = 0;
      do {
        Residence residence = new Residence();
        residence.id = cursor.getLong(columnIndex++);
        residence.geolocation = cursor.getString(columnIndex++);
        residence.date = Long.parseLong(cursor.getString(columnIndex++));
        residence.rented = cursor.getString(columnIndex++).equalsIgnoreCase(&quot;yes&quot;) ? true : false;
        residence.tenant = cursor.getString(columnIndex++);
        residence.zoom = Double.parseDouble(cursor.getString(columnIndex++));
        residence.photo = cursor.getString(columnIndex++);
        columnIndex = 0;

        residences.add(residence);
      } while (cursor.moveToNext());
    }
    cursor.close();
    return residences;
  }

  /**
   * Delete all records
   */
  public void deleteResidences() {
    SQLiteDatabase db = this.getWritableDatabase();
    try {
      db.execSQL(&quot;delete from tableResidences&quot;);
    }
    catch (Exception e) {
      Log.d(TAG, &quot;delete residences failure: &quot; + e.getMessage());
    }
  }

  /**
   * Queries the database for the number of records.
   *
   * @return The number of records in the dataabase.
   */
  public long getCount() {
    SQLiteDatabase db = this.getReadableDatabase();
    long numberRecords = DatabaseUtils.queryNumEntries(db, TABLE_RESIDENCES);
    db.close();
    return numberRecords;
  }

  /**
   * Update an existing Residence record.
   * All fields except record id updated.
   *
   * @param residence The Residence record being updated.
   */
  public void updateResidence(Residence residence) {
    SQLiteDatabase db = this.getWritableDatabase();
    try {
      ContentValues values = new ContentValues();
      values.put(GEOLOCATION, residence.geolocation);
      values.put(DATE, residence.date);
      values.put(RENTED, residence.rented == true ? &quot;yes&quot; : &quot;no&quot;);
      values.put(TENANT, residence.tenant);
      values.put(ZOOM, Double.toString(residence.zoom));
      values.put(PHOTO, residence.photo);
      db.update(&quot;tableResidences&quot;, values, &quot;id&quot; + &quot;=?&quot;, new String[]{residence.id + &quot;&quot;});
    }
    catch (Exception e) {
      Log.d(TAG, &quot;update residences failure: &quot; + e.getMessage());
    }
  }

  @Override
  public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
    db.execSQL(&quot;drop table if exists &quot; + TABLE_RESIDENCES);
    Log.d(TAG, &quot;onUpdated&quot;);
    onCreate(db);
  }
}</code></pre>
<p>Test the new feature by:</p>
<ul>
<li>populating the list view with a variety of residences, closing the app and reopening. Is the list correct?</li>
<li>Delete a selection from the list, close and reopen. Again, verify the list is correct.</li>
</ul>
<p>The application at the end of this lab is available for reference here: <a href="https://github.com/wit-ictskills-2016/myrent-12.git">myrent-12</a></p>

      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        Eamonn de Leastar & John Fitzgerald.
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      
$(document).ready(function()
{
  $("img").addClass ("ui image");
  $('.ui.embed').embed();

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });


  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>