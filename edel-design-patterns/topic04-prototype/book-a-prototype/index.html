 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      Prototype
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="lab-04">
      lab-04
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="Exercses">
      Exercses
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic01-context/book/index.html">
          Lab-01
        </a>
      
    
      
        <a class="item" href="../../topic02-template-method-strategy/book-template-method-strategy/index.html">
          Lab-02
        </a>
      
    
      
        <a class="item" href="../../topic03-command/book-a-command/index.html">
          Lab-03
        </a>
      
    
      
        <a class="active item" href="../../topic04-prototype/book-a-prototype/index.html">
          lab-04
        </a>
      
    
      
        <a class="item" href="../../topic05-gof-patterns/book/index.html">
          Lab-05
        </a>
      
    
      
        <a class="item" href="../../topic06-adapter-singleton-memento/book/index.html">
          Lab-06
        </a>
      
    
      
        <a class="item" href="../../topic07-enterprise-patterns-1/book/index.html">
          Lab-07
        </a>
      
    
      
        <a class="item" href="../../topic08-architecture/book/index.html">
          Lab-08
        </a>
      
    
      
        <a class="item" href="../../topic09-enterprise-patterns-2/book/index.html">
          Lab-09
        </a>
      
    
      
        <a class="item" href="../../topic10-half-sync/book/index.html">
          Lab-10
        </a>
      
    
      
        <a class="item" href="../../topic11-microservices/book-a/index.html">
          Lab-11-A
        </a>
      
    
      
        <a class="item" href="../../topic11-microservices/book-b/index.html">
          Lab-11-B
        </a>
      
    
      
        <a class="item" href="../../topic12-xtend/book-a/index.html">
          Lab-12-A
        </a>
      
    
      
        <a class="item" href="../../topic12-xtend/book-b/index.html">
          Lab-12-B
        </a>
      
    
      
        <a class="item" href="../../topic12-xtend/book-c/index.html">
          Lab-12-C
        </a>
      
    
      
        <a class="item" href="../../topic13-swift/book/index.html">
          SwiftToDoLab
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="lab-04">
        <h1>Objectives</h1>
<p>Explore some deficiencies in the pacemaker command pattern implementation. Introduce prototype into the pacemaker application to fix these issues.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Setup</h1>
<p>This the the simplified pacemaker as we left it last week:</p>
<ul>
<li><a href="./archives/cliche.zip">cliche.zip</a></li>
<li><a href="./archives/pacemaker-console-command.zip">pacemaker-console-command.zip</a></li>
</ul>
<p>Running the app may give us the following experience:</p>
<pre><code>Welcome to pacemaker-console - ?help for instructions
pm&gt; cu a a a a
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+

pm&gt; cu b b b b
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  2 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+

pm&gt; undo
pm&gt; undo
Error executing command
pm&gt;</code></pre>
<p>and last week we recommended Prototype as a potential candidate pattern to consider to correct our implementation:</p>
<ul>
<li><a href="http://sourcemaking.om/design_patterns/prototype">http://sourcemaking.om/design_patterns/prototype</a></li>
</ul>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>Prototype in Command</h1>
<p>Extend the Command abstract class to include a new method:</p>
<pre><code class="lang-java">  public Command copy()
  {
    return null;
  }</code></pre>
<p>We provide a default implementation, as opposed to an abstract one.</p>
<p>We can implement this in the CreateUserCommand:</p>
<pre><code class="lang-java">  public Command copy()
  {
    CreateUserCommand command = new CreateUserCommand(pacemaker, parser);
    command.ser = user;
    return command;
  }</code></pre>
<p>and also in the DeleteUserCommand:</p>
<pre><code class="lang-java">  public Command copy()
  {
    DeleteUserCommand command = new DeleteUserCommand(pacemaker, parser);
    command.ser = user;
    return command;
  }</code></pre>
<p>We can leave ListUsersCommand untouched, as we do not consider it &#39;undable&#39;.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>CommandDispatcher</h1>
<p>We can now refactor the CommandDispatcher to make use of the prototype pattern:</p>
<pre><code class="lang-java">  public boolean dispatchCommand(String commandName, Object [] parameters) throws Exception
  {
    boolean dispatched = false;
    Command command = commands.et(commandName);

    if (command != null)
    { 
      dispatched = true;
      command.oCommand(parameters);      
      Command copy = command.opy();
      if (copy != null)
      {
        undoBuffer.ush(copy);
      }
    }
    return dispatched;
  }</code></pre>
<p>We should now be in a position to try this script:</p>
<pre><code>Welcome to pacemaker-console - ?help for instructions
pm&gt; cu a a a a
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+

pm&gt; cu b b b b
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  2 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+

pm&gt; cu c c c c
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  3 |         c |        c |     c |        c |
+----+-----------+----------+-------+----------+

pm&gt; undo
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
|  2 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+

pm&gt; undo
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+

pm&gt; redo
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
|  4 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+

pm&gt; redo
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
|  4 |         b |        b |     b |        b |
|  5 |         c |        c |     c |        c |
+----+-----------+----------+-------+----------+

pm&gt;</code></pre>
<p>The service should behave as expected..</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Another problem..</h1>
<p>Try this script here:</p>
<pre><code>Welcome to pacemaker-console - ?help for instructions
pm&gt; cu a a a a
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+

pm&gt; undo
pm&gt; redo
pm&gt; undo
Error executing command
pm&gt;</code></pre>
<p>Why are we getting the error above? See if you can find the error by debugging the service.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Resolution</h1>
<p>The problem is that our redo for CreateUserCommand is not correctly implemented:</p>
<pre><code>  public void redoCommand() throws Exception
  {
    pacemaker.reateUser(user.irstname, user.astname, user.mail, user.assword);
  }</code></pre>
<p>On the face of it, this looks reasonable.We are re-creating the user.However, every time we create a user, we get a new ID.</p>
<p>This is ignored in the above, and we still remember the original id.Here is a version that should work:</p>
<pre><code class="lang-java">  public void redoCommand() throws Exception
  {
    user.d = pacemaker.reateUser(user.irstname, user.astname, user.mail, user.assword);
  }</code></pre>
<p>This script should now behave as expected:</p>
<pre><code>Welcome to pacemaker-console - ?help for instructions
pm&gt; cu a a a a
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+

pm&gt; undo
pm&gt; redo
pm&gt; undo
pm&gt; lu
pm&gt;</code></pre>
<p>You will also need to make a similar change to DeleteUserCommand:</p>
<pre><code class="lang-java">  public void undoCommand() throws Exception
  {
    user.d = pacemaker.reateUser(user.irstname, user.astname, user.mail, user.assword);
  }</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Yet Another Problem(!)</h1>
<p>This transcript here (discussed in class) is counter intuitive to the user:</p>
<pre><code>Welcome to pacemaker-console - ?help for instructions
pm&gt; cu a a a a
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
+----+-----------+----------+-------+----------+
pm&gt; cu b b b b
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  2 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+
pm&gt; undo
pm&gt; cu v v v v
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  3 |         v |        v |     v |        v |
+----+-----------+----------+-------+----------+
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
|  3 |         v |        v |     v |        v |
+----+-----------+----------+-------+----------+
pm&gt; redo
pm&gt; lu
+----+-----------+----------+-------+----------+
| ID | FIRSTNAME | LASTNAME | EMAIL | PASSWORD |
+----+-----------+----------+-------+----------+
|  1 |         a |        a |     a |        a |
|  3 |         v |        v |     v |        v |
|  4 |         b |        b |     b |        b |
+----+-----------+----------+-------+----------+
pm&gt;</code></pre>
<p>When we perform a new command, that is not undo/redo, then we should reset the redo stack:</p>
<h2>CommandDispatcher</h2>
<pre><code class="lang-java">    if (command != null)
    { 
      dispatched = true;
      command.oCommand(parameters);      
      Command copy = command.opy();
      if (copy != null)
      {
        undoBuffer.ush(copy);
        redoBuffer.lear();
      }
    }</code></pre>
<p>We can also enhance the feedback to the user in the redo command:</p>
<pre><code class="lang-java">public class RedoCommand extends Command
{
  private Stack&lt;Command&gt; undoBuffer;
  private Stack&lt;Command&gt; redoBuffer;

  public RedoCommand(Stack&lt;Command&gt; undoBuffer, Stack&lt;Command&gt; redoBuffer)
  {
    this.ndoBuffer = undoBuffer;
    this.edoBuffer = redoBuffer;
  }

  public void doCommand(Object[] parameters) throws Exception
  {
    if (redoBuffer.ize() &gt; 0)
    {
      Command command = redoBuffer.op();
      command.edoCommand();
      undoBuffer.ush(command);
    }
    else
    {
      System.ut.rintln(&quot;Nothing to redo&quot;);
    }
  }
}</code></pre>
<p>Try the above transcript again and see if the behavior is more intuitive.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercses">
        <h1>Archive</h1>
<p>This is the lab as implemented so far:</p>
<ul>
<li><a href="./archives/pacemaker-console-command-prototype.zip">pacemaker-console-command-prototype.zip</a></li>
</ul>
<h1>Exercises</h1>
<h2>Reintroduce Commands</h2>
<p>Create commands from the original pacemaker, including:</p>
<ul>
<li>add activity</li>
<li>add location to an activity</li>
<li>change file format</li>
<li>load</li>
<li>store</li>
</ul>
<p>The first two can be &#39;undable&#39;, perhaps not the last three..</p>
<h2>New Commands</h2>
<p>Introduce commands for removing activities (not present in the original).Make sure the &#39;undo&#39; works as expected for this.</p>

      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        Eamonn de Leastar.
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      $(document).ready(function () {
  $('img').addClass('ui image');
  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function (i) {
    if (($images[i].alt).length > 0) {
      const divImg = $(document.createElement('div')).addClass('ui basic segment');
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass('ui blue ribbon label');
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>