 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      Test Driven Development II
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-05">
      Lab-05
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07">
      07
    </a>
    
    <a class="item" data-tab="08">
      08
    </a>
    
    <a class="item" data-tab="Exercises">
      Exercises
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic01 - paradigms and languages/book/index.html">
          Lab-01
        </a>
      
    
      
        <a class="item" href="../../topic02 - java language/book/index.html">
          Lab-02
        </a>
      
    
      
        <a class="item" href="../../topic03 - inheritance and collections/book/index.html">
          Lab-03
        </a>
      
    
      
        <a class="item" href="../../topic04 - serialisation and TDD I/book/index.html">
          Lab-04
        </a>
      
    
      
        <a class="active item" href="../../topic05 - TDD II/book/index.html">
          Lab-05
        </a>
      
    
      
        <a class="item" href="../../topic06 - exceptions and maven/book/index.html">
          Lab-06
        </a>
      
    
      
        <a class="item" href="../../topic08 - framework and cloud/book-1/index.html">
          Lab-08a
        </a>
      
    
      
        <a class="item" href="../../topic08 - framework and cloud/book-2/index.html">
          Lab-08b
        </a>
      
    
      
        <a class="item" href="../../topic09 - SRP/book-1/index.html">
          Lab-09a
        </a>
      
    
      
        <a class="item" href="../../topic09 - SRP/book-2/index.html">
          Lab-09b
        </a>
      
    
      
        <a class="item" href="../../topic10 - OCP and play testing/book-1/index.html">
          Lab-10
        </a>
      
    
      
        <a class="item" href="../../topic11 - semantic and TDD IV/book-1/index.html">
          Lab-11a
        </a>
      
    
      
        <a class="item" href="../../topic11 - semantic and TDD IV/book-2/index.html">
          Lab-11b
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-05">
        <h2>Objectives</h2>
<ul>
<li>Create a new project to host a version of pacemaker implemented in Xtend</li>
<li>Build the project + its unit tests</li>
<li>Explore the generated Java sources</li>
</ul>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h2>Create xtend project</h2>
<p>Create a new eclipse java project called pacemaker-console-x. </p>
<p>Initialize the project as a git repository (see lab 1, step 6) - and replace the generated .gitignore file with this one here:</p>
<pre><code># Ignore all dotfiles...
.*
# except for .gitignore
!.gitignore
!.classpath
!.project

*.java
*.xml


/bin
./xtend-gen/**
.settings</code></pre>
<p>Note, your .gitignore file is the one selected in this illustration:</p>
<p><img src="img/00a.png" alt=""></p>
<p>Now commit the project - with a simple message:</p>
<p><img src="img/00.png" alt=""></p>
<p>Your blank workspace will look like this:</p>
<p><img src="img/01.png" alt=""></p>
<p>In src, create a new package called &#39;models&#39;. Then, in this package, create a new xtend class called &#39;User&#39;. Xtend options should be available from the &#39;other&#39; category:</p>
<p><img src="img/02.png" alt=""></p>
<p>The generated class will trigger errors. Fix these using autocorrect -</p>
<p><img src="img/03.png" alt=""></p>
<p>This should reconfigure workspace as follows:</p>
<p><img src="img/04.png" alt=""></p>
<p>If the error persists in the editor - then close and reopen the file.</p>
<p>Now we will try or first xtend class:</p>
<pre><code class="lang-java">import org.eclipse.xtend.lib.annotations.Data

@Data class User 
{
  Long   id
  String firstname
  String lastname 
  String email
  String password
}</code></pre>
<p>Replace the blank User with the above and save. Some interesting things will happen to the workspace:</p>
<p><img src="img/05.png" alt=""></p>
<p>If Eclipse didn&#39;t create the <strong>xtend-gen</strong> folder, right click on the project name and select <strong>Build Project</strong>.</p>
<p>Have a look at the new java version of our User class:</p>
<pre><code class="lang-java">package models;

import org.eclipse.xtend.lib.annotations.Data;
import org.eclipse.xtext.xbase.lib.Pure;
import org.eclipse.xtext.xbase.lib.util.ToStringBuilder;

@Data
@SuppressWarnings(&quot;all&quot;)
public class User {
  private final Long id;

  private final String firstname;

  private final String lastname;

  private final String email;

  private final String password;

  public User(final Long id, final String firstname, final String lastname, final String email, final String password) {
    super();
    this.id = id;
    this.firstname = firstname;
    this.lastname = lastname;
    this.email = email;
    this.password = password;
  }

  @Override
  @Pure
  public int hashCode() {
    final int prime = 31;
    int result = 1;
    result = prime * result + ((this.id== null) ? 0 : this.id.hashCode());
    result = prime * result + ((this.firstname== null) ? 0 : this.firstname.hashCode());
    result = prime * result + ((this.lastname== null) ? 0 : this.lastname.hashCode());
    result = prime * result + ((this.email== null) ? 0 : this.email.hashCode());
    result = prime * result + ((this.password== null) ? 0 : this.password.hashCode());
    return result;
  }

  @Override
  @Pure
  public boolean equals(final Object obj) {
    if (this == obj)
      return true;
    if (obj == null)
      return false;
    if (getClass() != obj.getClass())
      return false;
    User other = (User) obj;
    if (this.id == null) {
      if (other.id != null)
        return false;
    } else if (!this.id.equals(other.id))
      return false;
    if (this.firstname == null) {
      if (other.firstname != null)
        return false;
    } else if (!this.firstname.equals(other.firstname))
      return false;
    if (this.lastname == null) {
      if (other.lastname != null)
        return false;
    } else if (!this.lastname.equals(other.lastname))
      return false;
    if (this.email == null) {
      if (other.email != null)
        return false;
    } else if (!this.email.equals(other.email))
      return false;
    if (this.password == null) {
      if (other.password != null)
        return false;
    } else if (!this.password.equals(other.password))
      return false;
    return true;
  }

  @Override
  @Pure
  public String toString() {
    ToStringBuilder b = new ToStringBuilder(this);
    b.add(&quot;id&quot;, this.id);
    b.add(&quot;firstname&quot;, this.firstname);
    b.add(&quot;lastname&quot;, this.lastname);
    b.add(&quot;email&quot;, this.email);
    b.add(&quot;password&quot;, this.password);
    return b.toString();
  }

  @Pure
  public Long getId() {
    return this.id;
  }

  @Pure
  public String getFirstname() {
    return this.firstname;
  }

  @Pure
  public String getLastname() {
    return this.lastname;
  }

  @Pure
  public String getEmail() {
    return this.email;
  }

  @Pure
  public String getPassword() {
    return this.password;
  }
}</code></pre>
<p>This have been generated by eclipse - and is compiled by the standard java compiler.</p>
<p>Commit these changes to git. Note that our .gitignore means that we will not be offered an opportunity to commit the java source. This is intentional - as we are happy to work in xtend only.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h2>Incorporate Junit</h2>
<p>The next step will be to create a unit test to verify our understanding of the Xtend class. Before doing this, add JUnit4 as a library for the project (Project-&gt;Properties-&gt;Build Path-&gt;Libraries-&gt;Add Library)</p>
<p>In Eclipse, create a new &#39;source folder&#39; called &#39;test&#39; in the root of the project. In that folder create an new package called models:</p>
<p><img src="img/06.png" alt=""></p>
<p>Create a new xtend class called &#39;UserTest&#39; in this package, and incorporate the following:</p>
<pre><code class="lang-java">package models

import static org.junit.Assert.*
import org.junit.Test
import org.junit.Before
import org.junit.After

class UserTest 
{

  val String userStr = &#39;User [\n  id = 0\n  firstname = &quot;homer&quot;\n  lastname = &quot;simpson&quot;\n  email = &quot;homer@simpson.com&quot;\n  password = &quot;secret&quot;\n]&#39; 

  var User homer 

  @Before
  def void setup()
  {
    homer = new User(0l, &quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;,  &quot;secret&quot;)
  }

  @After 
  def void tearDown()
  {
    homer = null
  }

  @Test 
  def void testCreate()
  {
    assertEquals (&quot;homer&quot;,               homer.firstname)
    assertEquals (&quot;simpson&quot;,             homer.lastname)
    assertEquals (&quot;homer@simpson.com&quot;,   homer.email) 
    assertEquals (&quot;secret&quot;,              homer.password)  
  }

  @Test 
  def void testToString()
  {
    assertEquals (userStr, homer.toString)
  }
}</code></pre>
<p>This test should pass - and verifies our understanding of how simple @Data classes in xtend function. We might try another simple test:</p>
<pre><code class="lang-java">  @Test def void testEquals()
  {
   val anotherHomer = new User(0l, &quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;,  &quot;secret&quot;)
   val marge        = new User(0l, &quot;marge&quot;, &quot;simpson&quot;, &quot;marge@simpson.com&quot;,  &quot;secret&quot;)

   assertEquals   (homer, anotherHomer)
   assertNotSame  (homer, anotherHomer)
   assertNotEquals(homer, marge)
  }</code></pre>
<p>This verifies that the generated equals() method works as expected. Commit these changes with a suitable message.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>@Data class</h1>
<p>Create a new model class called Activity:</p>
<pre><code class="lang-java">package models

import org.eclipse.xtend.lib.annotations.Data

@Data class Activity 
{
  Long     id
  String   type
  String   location
  double   distance
}</code></pre>
<p>and a new test to exercise it:</p>
<pre><code class="lang-java">package models

import static org.junit.Assert.*
import org.junit.Test
import org.junit.Before
import org.junit.After

class ActivityTest
{
  val String activityStr = &#39;Activity [\n  id = 0\n  type = &quot;walk&quot;\n  location = &quot;fridge&quot;\n  distance = 0.001\n]&#39;  

  var Activity activity 

  @Before
  def void setup()
  {
    activity = new Activity (0l, &quot;walk&quot;,  &quot;fridge&quot;, 0.001)
  }

  @After 
  def void tearDown()
  {
    activity = null
  }

  @Test 
  def void testCreate()
  {
    assertEquals (&quot;walk&quot;,          activity.type)
    assertEquals (&quot;fridge&quot;,        activity.location)
    assertEquals (0.0001, 0.001,   activity.distance)    
  }  

  @Test 
  def void testToString()
  {
    assertEquals (activityStr, activity.toString)
  }
}</code></pre>
<p>This test should pass. There is no need to test the equals() method, as we have verified this basic operation for User.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>Map as Property</h1>
<p>We now establish the relationship between users and activities - introduce a new attribute to the User class:</p>
<pre><code class="lang-java">  @Accessors Map&lt;Long, Activity&gt; activities = new HashMap</code></pre>
<p>(user autocorrect to bring in the appropriate includes)</p>
<p>Run our unit tests - the toString test for User will fail immediately. This is because our generated toString method is now also rendering the activities attribute. Change the test fixture to accommodate this:</p>
<pre><code class="lang-java">
   val String userStr = &#39;User [\n  id = 0\n  firstname = &quot;homer&quot;\n  lastname = &quot;simpson&quot;\n  email = &quot;homer@simpson.com&quot;\n  password = &quot;secret&quot;\n  activities = {}\n]&#39;</code></pre>
<p>The test should now succeed.</p>
<p>We can complete the model classes now - introduce a new Location class:</p>
<pre><code class="lang-java">package models

import org.eclipse.xtend.lib.annotations.Data

@Data class Location
{
  float latitude 
  float longitude 
}</code></pre>
<p>and in Activity, establish the relationship to Location:</p>
<pre><code class="lang-java">  @Accessors List&lt;Location&gt; route = new ArrayList</code></pre>
<p>As with UserTest, the ActivityTest will fail - so we adjust the fixture to include the new reference to Locations:</p>
<pre><code class="lang-java">  val String activityStr = &#39;Activity [\n  id = 0\n  type = &quot;walk&quot;\n  location = &quot;fridge&quot;\n  distance = 0.001\n  route = ArrayList ()\n]&#39;</code></pre>
<p>The tests should now pass. </p>
<p>For the moment we choose not to introduce tests for Location - as the class is so simple we would merely be testing the generated code. This is unnecessary, the tests we have written so far should be enough to confirm our understanding of how these @Data Xtend classes work.</p>
<p>Commmit the changes made so far.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>PacemakerAPI</h1>
<p>Create a new package called &#39;controllers&#39; and a class therein called &quot;PacemakerAPI&quot;. Mirror this with a corresponding test class:</p>
<p><img src="img/07.png" alt=""></p>
<p>We will try writing the unit tests slightly ahead of the class under test. In the pacemakerAPITest, lets bring in the basic test support:</p>
<pre><code class="lang-java">package controllers

import static org.junit.Assert.*
import org.junit.Test
import org.junit.Before
import org.junit.After
import models.User
import models.Location
import controllers.PacemakerAPI

class PacemakerAPITest
{
  @Before
  def void setup()
  {
  }

  @After 
  def void tearDown()
  {
  }
}</code></pre>
<p>Now create a fixture:</p>
<pre><code class="lang-java">  var PacemakerAPI pacemakerAPI

  @Before
  def void setup()
  {
    pacemakerAPI = new PacemakerAPI()
  }

  @After 
  def void tearDown()
  {
    pacemakerAPI = null
  }</code></pre>
<p>... and a new test:</p>
<pre><code class="lang-java">  @Test def void createUser()
  {
    val homer    = new User(1l, &quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;,  &quot;secret&quot;)

    assertEquals (0, pacemakerAPI.users.size)
    val id = pacemakerAPI.createUser(&quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;, &quot;secret&quot;)
    assertEquals (1, pacemakerAPI.users.size)
    assertEquals (homer, pacemakerAPI.getUser(id))
  }</code></pre>
<p>This will fail to compile - as the PacemakerAPI class is currently blank.</p>
<p>We can try the absolute minimum to get the test to compile - and no more. i.e. we would like the test to compile - and then fail when run. Here is a version of PacemakerAPI that will at least compile:</p>
<pre><code class="lang-java">package controllers

import models.User
import java.util.Collection

class PacemakerAPI 
{
  @Accessors Collection&lt;User&gt; users

  def Long createUser (String firstName, String lastName, String email, String password) 
  { 
  }

  def getUser (Long id)
  {
  }     
}</code></pre>
<p>Note: if your test class isn&#39;t compiling after copying in the above code, <strong>build</strong> the project again by right clicking on the project name and selecting &quot;Build Project&quot;.</p>
<p>Try the test now - and verify that it compiles successfully, although fails to execute.</p>
<p>The following version of PacemakerAPI should pass:</p>
<pre><code class="lang-java">class PacemakerAPI 
{
  static long userIndex = 0

  val Map&lt;Long,   User&gt;      userMap = new HashMap
  @Accessors Collection&lt;User&gt; users   = userMap.values

  def createUser (String firstName, String lastName, String email, String password) 
  { 
    userIndex = userIndex + 1
    userMap.put(userIndex, new User (userIndex, firstName, lastName, email, password))
    userIndex
  }

  def getUser (Long id)
  {
    userMap.get(id)
  }     
}</code></pre>
<p>Note the subtle change in the signature for createUser.</p>
<p>Commit these changes.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>PacemakerAPITest</h1>
<p>Introduce some test data into PacemakerAPI class we can use to exercise the api more throughly:</p>
<pre><code class="lang-java">  public static val users = newArrayList
  ( new User (1l, &quot;marge&quot;, &quot;simpson&quot;, &quot;marge@simpson.com&quot;,  &quot;secret&quot;),
    new User (2l, &quot;lisa&quot;,  &quot;simpson&quot;, &quot;lisa@simpson.com&quot;,   &quot;secret&quot;),
    new User (3l, &quot;bart&quot;,  &quot;simpson&quot;, &quot;bart@simpson.com&quot;,   &quot;secret&quot;),
    new User (4l, &quot;maggie&quot;,&quot;simpson&quot;, &quot;maggie@simpson.com&quot;, &quot;secret&quot;) )</code></pre>
<p>Now the setup method can create 4 users:</p>
<pre><code class="lang-java">  @Before
  def void setup()
  {
    pacemakerAPI = new PacemakerAPI()
    users.forEach [pacemakerAPI.createUser(firstname, lastname, email, password)]
  }</code></pre>
<p>This will require a slight change to the existing test:</p>
<pre><code class="lang-java">  @Test 
  def void createUser()
  {
    val homer    = new User(5L, &quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;,  &quot;secret&quot;)

    assertEquals (users.size, pacemakerAPI.users.size)
    val id = pacemakerAPI.createUser(&quot;homer&quot;, &quot;simpson&quot;, &quot;homer@simpson.com&quot;, &quot;secret&quot;)
    assertEquals (users.size+1, pacemakerAPI.users.size)
    assertEquals (homer, pacemakerAPI.getUser(id))
  }</code></pre>
<p>... and we can introduce a more complete test of addActivity:</p>
<pre><code class="lang-java">  @Test
  def void testUsers()
  {
    assertEquals (users.size, pacemakerAPI.users.size)

    assertEquals (users.size, pacemakerAPI.users.size)
    users.forEach [ val eachUser = pacemakerAPI.getUser(email)
                    assertEquals (it, eachUser)
                    assertNotSame(it, eachUser) ] 
  }</code></pre>
<p>This last test will fail to compile, as we have yet to implement getUser taking an email.</p>
<p>Here is a rework of PacemakerAPI to accommodate the a new email index:</p>
<pre><code class="lang-java">class PacemakerAPI 
{
  static long userIndex = 0

  val Map&lt;Long,   User&gt;      userMap = new HashMap
  val Map&lt;String, User&gt;      userEmailMap  = new HashMap  
  @Accessors Collection&lt;User&gt; users   = userMap.values

  def createUser (String firstName, String lastName, String email, String password) 
  { 
    userIndex = userIndex + 1
    val user = new User (userIndex, firstName, lastName, email, password)
    userMap.put(userIndex, user)
    userEmailMap.put(user.email, user)
    userIndex
  }

  def getUser (Long id)
  {
    userMap.get(id)
  }  

  def getUser (String email)
  {
    userEmailMap.get(email)
  }</code></pre>
<p>Run all of the tests again - we still have a fail, but this time back in the test we thought we had concluded. Why is this?</p>
<p>The fix is to intoduce a constructor into PacemakerAPI to reset the index to 0 every time we create a PacemakerAPI object:</p>
<pre><code class="lang-java">  new()
  {
    userIndex = 0
  }</code></pre>
<p>Test this again, it should pass.</p>
<p>We should also introduce ability to delete users. First, the test:</p>
<pre><code>  @Test 
  def void testDeleteUsers()
  {
    assertEquals (users.length, pacemakerAPI.users.size)
    val user = pacemakerAPI.getUser(&quot;marge@simpson.com&quot;)
    pacemakerAPI.deleteUser(user.id)
    assertEquals (users.length-1, pacemakerAPI.users.size)  
  }</code></pre>
<p>.. and the implementation:</p>
<pre><code class="lang-java">  def deleteUser (Long id)
  {
    userEmailMap.remove(userMap.get(id))
    userMap.remove(id)
  }</code></pre>
<p>All test should pass.</p>
<p>Commit changes.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07">
        <h1>Activity Support</h1>
<p>The following three methods in PacemakerAPI should round of the features we need:</p>
<pre><code class="lang-java">  def Activity createActivity(Long id, String type, String location, double distance)
  {
  }

  def Activity getActivity (Long id)
  {
  }

  def void addLocation (Long id, float latitude, float longitude)
  {
  }</code></pre>
<p>These are how we might articulate the tests:</p>
<pre><code class="lang-java">  @Test def void testAddActivity()
  {
    val activity = pacemakerAPI.createActivity(pacemakerAPI.getUser(&quot;marge@simpson.com&quot;).id,  &quot;run&quot;, &quot;springfield&quot;, 5)

    val returnedActivity = pacemakerAPI.getActivity(activity.id);
    assertEquals(activity,  returnedActivity);
  }   

  @Test def void testAddActivityWithSingleLocation()
  {
    val activity = pacemakerAPI.createActivity(pacemakerAPI.getUser(&quot;marge@simpson.com&quot;).id,  &quot;run&quot;, &quot;springfield&quot;, 5)

    val location = new Location(23.3f, 33.3f)

    val returnedActivity = pacemakerAPI.getActivity(activity.id)

    pacemakerAPI.addLocation(returnedActivity.id, location.latitude, location.longitude)

    val otherActivity = pacemakerAPI.getActivity(returnedActivity.id)
    assertEquals (1, otherActivity.route.size)
    assertEquals(0.0001, location.latitude,  otherActivity.route.get(0).latitude)
    assertEquals(0.0001, location.longitude, otherActivity.route.get(0).longitude);  
  }   

  @Test def void testAddActivityWithMultipleLocation()
  {
    val locations = newArrayList
     (
      new Location(23.3f, 33.3f),
      new Location(34.4f, 45.2f),  
      new Location(25.3f, 34.3f),
      new Location(44.4f, 23.3f)       
     )

    val activity = pacemakerAPI.createActivity(pacemakerAPI.getUser(&quot;marge@simpson.com&quot;).id,  &quot;run&quot;, &quot;springfield&quot;, 5)

    val returnedActivity = pacemakerAPI.getActivity(activity.id)

    locations.forEach[ pacemakerAPI.addLocation(returnedActivity.id, latitude, longitude)]    

    val otherActivity = pacemakerAPI.getActivity(returnedActivity.id)
    assertEquals (locations.size, otherActivity.route.size)
    assertEquals (locations, otherActivity.route)
   }</code></pre>
<p>These tests are reasonably exhaustive. Now to implement activities in PacemakerAPI.</p>
<p>First, a revision of the key attributes:</p>
<pre><code class="lang-java">class PacemakerAPI 
{
  static long userIndex     = 0
  static long activityIndex = 0

  val Map&lt;Long,   User&gt;      userMap       = new HashMap
  val Map&lt;String, User&gt;      userEmailMap  = new HashMap  
  var Map&lt;Long,   Activity&gt;  activityMap   = new HashMap  
  @Accessors Collection&lt;User&gt; users         = userMap.values

  new()
  {
    userIndex     = 0
    activityIndex = 0
  }</code></pre>
<p>... and here is the implementation of the new methods stubbed earlier:</p>
<pre><code>  def Activity createActivity(Long id, String type, String location, double distance)
  {
    var Activity activity = null;
    var user = userMap.get(id)
    if (null != user)
    {
      activityIndex = activityIndex + 1
      activity = new Activity (activityIndex, type, location, distance)
      user.activities.put(activity.id, activity);
      activityMap.put(activity.id, activity);
    }
    return activity;
  }

  def getActivity (Long id)
  {
    activityMap.get(id)
  }

  def void addLocation (Long id, float latitude, float longitude)
  {
    val activity = activityMap.get(id)
    if (null != activity)
    {
      activity.route.add(new Location(latitude, longitude));
    }
  }</code></pre>
<p>Re-run the tests; they should all work. </p>
<p>We now have a reasonably comprehensive version of the API implemented. More importantly, we have a robust and expressive set of tests which will stand to our benefit as we introduce new features and capabilities.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="08">
        <h1>Serializers</h1>
<p>The final test sequence is to verify correct implementation of the persistence mechanism. This will be implemented in a new package called utils.</p>
<p>Create this package now, and incorporate the following interface:</p>
<pre><code class="lang-java">package utils

interface Serializer 
{
  def void push(Object o)
  def Object pop()
  def void write()
  def void read()
}</code></pre>
<p>In the same package, introduce this implementation of Serializer:</p>
<pre><code class="lang-java">package utils

import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.io.xml.DomDriver;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Deque
import java.util.ArrayDeque

class XMLSerializer implements Serializer
{
  var Deque&lt;Object&gt; stack = new ArrayDeque
  val File file;

  new (File file)
  {
    this.file = file
  }

  def override void push(Object o)
  {
    stack.push(o)
  }

  def override Object pop()
  {
    return stack.pop();
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  def override void read() 
  {
    var ObjectInputStream is = null

    try
    {
      val xstream = new XStream(new DomDriver())
      is = xstream.createObjectInputStream(new FileReader(file))
      stack = is.readObject as Deque&lt;Object&gt;
    }
    finally
    {
      if (is != null)
      {
        is.close();
      }
    }
  }

  def override void write() 
  {
    var ObjectOutputStream os = null

    try
    {
      val xstream = new XStream(new DomDriver())
      os = xstream.createObjectOutputStream(new FileWriter(file))
      os.writeObject(stack)
    }
    finally
    {
      if (os != null)
      {
        os.close
      }
    }
  }  
}</code></pre>
<p>This will require the thoughtworks xtream library to be added to the project (see lab01, step08).</p>
<p>Now the test - we create a separate test just focusing on persistence:</p>
<pre><code>package controllers

import static org.junit.Assert.*
import org.junit.Test
import org.junit.Before
import org.junit.After
import controllers.PacemakerAPI
import java.io.File
import utils.XMLSerializer
import utils.Serializer
import models.User
import models.Activity
import models.Location

class PersistenceTest 
{
  val users = newArrayList
  ( new User (1l, &quot;marge&quot;, &quot;simpson&quot;, &quot;marge@simpson.com&quot;,  &quot;secret&quot;),
    new User (2l, &quot;lisa&quot;,  &quot;simpson&quot;, &quot;lisa@simpson.com&quot;,   &quot;secret&quot;),
    new User (3l, &quot;bart&quot;,  &quot;simpson&quot;, &quot;bart@simpson.com&quot;,   &quot;secret&quot;),
    new User (4l, &quot;maggie&quot;,&quot;simpson&quot;, &quot;maggie@simpson.com&quot;, &quot;secret&quot;) )  

  val margesActivities = newArrayList
  ( new Activity (1l, &quot;walk&quot;,  &quot;fridge&quot;, 0.001),
    new Activity (2l, &quot;walk&quot;,  &quot;bar&quot;,    1.0),
    new Activity (3l, &quot;run&quot;,   &quot;work&quot;,   2.2))

  val lisasActivities = newArrayList  
  ( new Activity (4l, &quot;walk&quot;,  &quot;shop&quot;,   2.5),
    new Activity (5l, &quot;cycle&quot;, &quot;school&quot;, 4.5) )       

  public val locations = newArrayList
  ( new Location(23.3f, 33.3f),
    new Location(34.4f, 45.2f),  
    new Location(25.3f, 34.3f),
    new Location(44.4f, 23.3f) )    

  var PacemakerAPI pacemaker
  var Serializer   serializer
  val datastoreFile = &quot;testdatastore.xml&quot;;

  def void deleteFile(String fileName)
  {
    val datastore = new File (fileName)
    if (datastore.exists)
    {
      datastore.delete
    }
  }

  def void populate()
  {
    users.forEach [pacemaker.createUser(firstname, lastname, email, password)] 

    val marge = pacemaker.getUser(&quot;marge@simpson.com&quot;)
    margesActivities.forEach[ pacemaker.createActivity(marge.id, type, location, distance) ]

    locations.forEach[ pacemaker.addLocation(marge.activities.values.get(0).id, latitude, longitude)]

    val lisa = pacemaker.getUser(&quot;lisa@simpson.com&quot;)
    lisasActivities.forEach[ pacemaker.createActivity(lisa.id, type, location, distance) ]
  }

  @Before
  def void setup()
  {
    deleteFile (datastoreFile);
    serializer = new XMLSerializer(new File (datastoreFile))
    pacemaker = new PacemakerAPI(serializer) 
    populate
  }

  @After
  def void tearDown()
  {
    pacemaker = null
    serializer = null
    deleteFile (datastoreFile);
  }

  @Test def void testXMLSerializer() 
  { 
    pacemaker.store
    val pacemaker2 =  new PacemakerAPI(serializer)
    pacemaker2.load
    pacemaker.users.forEach [assertTrue(pacemaker2.users.contains(it))]
  }
}</code></pre>
<p>This requires new attributes and methods in PacemakerAPI:</p>
<pre><code class="lang-java">class PacemakerAPI 
{
  static long userIndex     = 0
  static long activityIndex = 0

  var Map&lt;Long,   User&gt;      userMap       = new HashMap
  var Map&lt;String, User&gt;      userEmailMap  = new HashMap  
  var Map&lt;Long,   Activity&gt;  activityMap   = new HashMap  
  @Accessors Collection&lt;User&gt; users         = userMap.values
  var Serializer             serializer

  new()
  {
    userIndex     = 0
    activityIndex = 0
  }

  new (Serializer serializer)
  {
    this.serializer = serializer
    userIndex       = 0
    activityIndex   = 0
  }

  def void load() throws Exception
  {
    serializer.read();
    activityIndex = serializer.pop() as Long
    userIndex     = serializer.pop() as Long
    activityMap   = serializer.pop() as Map&lt;Long, Activity&gt;
    userEmailMap  = serializer.pop() as Map&lt;String, User&gt;
    userMap       = serializer.pop() as Map&lt;Long, User&gt;
    users         = userMap.values
  }

  def void store() 
  {
    serializer.push(userMap)
    serializer.push(userEmailMap)
    serializer.push(activityMap)
    serializer.push(userIndex)
    serializer.push(activityIndex)
    serializer.write()
  }

  //... as before</code></pre>
<p>All tests should now pass.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercises">
        <h1>Exercises</h1>
<p>The project so far:</p>
<ul>
<li><a href="archives/pacemaker-console-x.zip">pacemaker-console-x</a></li>
</ul>
<h2>Exploring the XML File</h2>
<p>You can manually explore the generated xml file be commenting out the deletion of the file in the tearDown of PersistenceTest:</p>
<pre><code class="lang-java">  @After
  def void tearDown()
  {
    pacemaker = null
    serializer = null
    //deleteFile (datastoreFile);
  }</code></pre>
<p>Try this and see if you can relate the generated file to the unit test fixtures</p>
<h2>User Interface</h2>
<p>Missing form this solution is the User Interface. We already implemented this in Java. Convert this to Xtend. Use the generated xml file as the default model when the application is launched. See if the user/activities/locations are accurately restored.</p>
<h2>Json Serializer</h2>
<p>If you have made progress your JSon or Binary serializers, convert them to Xtend and write tests to verify their operation.</p>

      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        Eamonn de Leastar & Dr. Siobhan Drohan.
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      $(document).ready(function () {
  $('img').addClass('ui image');
  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function (i) {
    if (($images[i].alt).length > 0) {
      const divImg = $(document.createElement('div')).addClass('ui basic segment');
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass('ui blue ribbon label');
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>